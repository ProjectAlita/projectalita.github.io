name: Deploy Documentation to GitHub Pages

on:
  workflow_dispatch:  

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          repository: ProjectAlita/projectalita.github.io
          ref: redesign_getting_started_section

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install MkDocs and dependencies
        run: |
          pip install mkdocs mkdocs-material mkdocs-glightbox

      - name: Configure MkDocs for subdirectory deployment
        run: |
          echo "Configuring MkDocs for /docs/ subdirectory..."
          
          # Update site_url in mkdocs.yml
          if grep -q "# site_url:  use_directory_urls:  true" mkdocs.yml; then
            sed -i 's|# site_url: use_directory_urls: true|site_url: https://elitea.ai/docs/|g' mkdocs.yml
          elif grep -q "site_url:" mkdocs.yml; then
            sed -i 's|site_url: .*|site_url: https://elitea.ai/docs/|g' mkdocs.yml
          else
            sed -i '/site_name:/a site_url: https://elitea.ai/docs/' mkdocs.yml
          fi
          
          echo "MkDocs configuration (first 5 lines):"
          head -n 5 mkdocs.yml

      - name: Build MkDocs documentation
        run: mkdocs build --clean --strict --config-file mkdocs.yml

      - name:  Verify build output
        run: |
          echo "=== Checking built documentation ==="
          ls -la site/ | head -20
          
          if [ -f "site/index.html" ]; then
            echo "✓ site/index.html exists"
          else
            echo "✗ ERROR: site/index.html is missing!"
            exit 1
          fi

      - name: Deploy built site to landing repository
        uses:  peaceiris/actions-gh-pages@v3
        with: 
          deploy_key: ${{ secrets. ACTIONS_DEPLOY_KEY }}
          external_repository: projectalita/landing
          publish_branch: release
          publish_dir: ./site
          destination_dir: docs  # CHANGED FROM docs/docs to docs
          commit_message: 'Automated deployment from projectalita.github.io (commit ${{ github.sha }})'
          allow_empty_commit: false
          keep_files: false
          force_orphan: false
          enable_jekyll: false
          disable_nojekyll: false
          exclude_assets: '. github'
