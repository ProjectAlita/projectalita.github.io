name: On Project Item Status Change

on:
  # Triggered via webhook from GitHub Project automation
  # Or can be triggered manually for testing
  workflow_dispatch:
    inputs:
      issue_url:
        description: 'GitHub Issue URL to investigate'
        required: true
        type: string
      target_status:
        description: 'Target status column'
        required: true
        type: choice
        options:
          - 'To Do'
          - 'Bugs'
          - 'Development'

  # GitHub Projects V2 events (requires organization-level webhook or GitHub App)
  # Note: This event is only available for GitHub Apps, not personal access tokens
  # projects_v2_item:
  #   types: [edited]

permissions:
  issues: write
  contents: read

jobs:
  check-and-investigate:
    runs-on:
      group: ai-developer
    steps:
      - name: Process workflow dispatch
        if: github.event_name == 'workflow_dispatch'
        id: dispatch-input
        run: |
          echo "issue_url=${{ github.event.inputs.issue_url }}" >> $GITHUB_OUTPUT
          echo "target_status=${{ github.event.inputs.target_status }}" >> $GITHUB_OUTPUT

          # Extract issue number from URL
          ISSUE_URL="${{ github.event.inputs.issue_url }}"
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oE '[0-9]+$')
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          echo "üìã Processing issue: $ISSUE_URL"
          echo "üìä Target status: ${{ github.event.inputs.target_status }}"

      - name: Check issue assignee
        id: check-assignee
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_GIT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const issueUrl = '${{ steps.dispatch-input.outputs.issue_url }}';
            const targetStatus = '${{ steps.dispatch-input.outputs.target_status }}';

            // Parse owner, repo, and issue number from URL
            const urlMatch = issueUrl.match(/github\.com\/([^\/]+)\/([^\/]+)\/issues\/(\d+)/);
            if (!urlMatch) {
              core.setFailed(`Invalid issue URL: ${issueUrl}`);
              return;
            }

            const [, owner, repo, issueNumber] = urlMatch;
            console.log(`Checking issue ${owner}/${repo}#${issueNumber}`);

            // Get issue details
            const { data: issue } = await github.rest.issues.get({
              owner,
              repo,
              issue_number: parseInt(issueNumber)
            });

            // Check if assigned to target user
            const targetUsers = ['elitea-ai'];
            const isAssignedToTarget = issue.assignees.some(a => targetUsers.includes(a.login));

            if (!isAssignedToTarget) {
              console.log(`Issue not assigned to target users. Assignees: ${issue.assignees.map(a => a.login).join(', ')}`);
              core.setOutput('should_investigate', 'false');
              return;
            }

            console.log(`‚úÖ Issue is assigned to target user`);
            console.log(`üìä Target status: ${targetStatus}`);

            // Determine action based on status
            let action = 'none';
            if (targetStatus === 'To Do' || targetStatus === 'Bugs') {
              action = 'investigate';
            } else if (targetStatus === 'Development') {
              action = 'implement';
            }

            core.setOutput('should_investigate', action === 'investigate' ? 'true' : 'false');
            core.setOutput('should_implement', action === 'implement' ? 'true' : 'false');
            core.setOutput('issue_url', issueUrl);
            core.setOutput('issue_title', issue.title);
            core.setOutput('owner', owner);
            core.setOutput('repo', repo);
            core.setOutput('issue_number', issueNumber);

      - name: Run RCA Investigation (To Do / Bugs)
        if: steps.check-assignee.outputs.should_investigate == 'true'
        working-directory: /Volumes/KINGSTON/Development/elitea
        timeout-minutes: 30
        env:
          CLAUDE_CONFIG_DIR: /Volumes/KINGSTON/Development/elitea/.claude
        run: |
          echo "üîç Starting RCA investigation for: ${{ steps.check-assignee.outputs.issue_url }}"
          echo "Issue: ${{ steps.check-assignee.outputs.issue_title }}"

          # Read model names from settings.json
          SETTINGS_FILE="$CLAUDE_CONFIG_DIR/settings.json"
          export ANTHROPIC_SMALL_FAST_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")
          export ANTHROPIC_DEFAULT_HAIKU_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")
          export CLAUDE_CODE_SUBAGENT_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")

          echo "Using model for subagents: $ANTHROPIC_SMALL_FAST_MODEL"

          ISSUE_URL="${{ steps.check-assignee.outputs.issue_url }}"
          claude --debug --dangerously-skip-permissions --agent autonomous-rca-investigator -p "Investigate this GitHub issue and post your RCA findings as comments: $ISSUE_URL"

      - name: Run Auto-Fixer (Development)
        if: steps.check-assignee.outputs.should_implement == 'true'
        working-directory: /Volumes/KINGSTON/Development/elitea
        timeout-minutes: 60
        env:
          CLAUDE_CONFIG_DIR: /Volumes/KINGSTON/Development/elitea/.claude
        run: |
          echo "üîß Starting auto-fix implementation for: ${{ steps.check-assignee.outputs.issue_url }}"
          echo "Issue: ${{ steps.check-assignee.outputs.issue_title }}"

          # Read model names from settings.json
          SETTINGS_FILE="$CLAUDE_CONFIG_DIR/settings.json"
          export ANTHROPIC_SMALL_FAST_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")
          export ANTHROPIC_DEFAULT_HAIKU_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")
          export CLAUDE_CODE_SUBAGENT_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")

          echo "Using model for subagents: $ANTHROPIC_SMALL_FAST_MODEL"

          ISSUE_URL="${{ steps.check-assignee.outputs.issue_url }}"
          claude --debug --dangerously-skip-permissions --agent rca-autofixer -p "Implement fixes for this GitHub issue based on the RCA analysis and create a pull request: $ISSUE_URL"

      - name: Report completion
        if: always()
        run: |
          echo "=== Workflow Summary ==="
          echo "Issue URL: ${{ steps.check-assignee.outputs.issue_url }}"
          echo "Should Investigate: ${{ steps.check-assignee.outputs.should_investigate }}"
          echo "Should Implement: ${{ steps.check-assignee.outputs.should_implement }}"
          echo "Status: ${{ job.status }}"
