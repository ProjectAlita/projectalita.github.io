name: Delete stale branches

on:
  workflow_dispatch:
    inputs:
      cutoff_days:
        description: "Delete branches whose last commit is older than this many days"
        required: true
        default: "7"
      dry_run:
        description: "If true, only print branches that would be deleted"
        required: true
        type: boolean
        default: true
      keep_branches:
        description: "Comma-separated list of branch names to never delete"
        required: true
        default: "main,documentation,gh-pages"

permissions:
  contents: write

jobs:
  delete-stale:
    runs-on: ubuntu-latest

    steps:
      - name: Delete stale branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CUTOFF_DAYS: ${{ inputs.cutoff_days }}
          DRY_RUN: ${{ inputs.dry_run }}
          KEEP_BRANCHES: ${{ inputs.keep_branches }}
        run: |
          set -euo pipefail

          REPO="${GITHUB_REPOSITORY}"
          echo "Repository: ${REPO}"
          echo "Cutoff days: ${CUTOFF_DAYS}"
          echo "Dry run (raw input): '${DRY_RUN}'"
          echo "Keep branches: ${KEEP_BRANCHES}"

          # workflow_dispatch boolean inputs still arrive as strings: "true"/"false".
          # Never use them directly in a truthy check.
          if [[ "${DRY_RUN}" != "true" && "${DRY_RUN}" != "false" ]]; then
            echo "Unexpected DRY_RUN value: '${DRY_RUN}' (expected 'true' or 'false')" >&2
            exit 1
          fi

          # Convert cutoff to epoch seconds
          CUTOFF_EPOCH=$(date -d "-${CUTOFF_DAYS} days" +%s)

          # Parse keep list into an array
          IFS=',' read -r -a KEEP_ARR <<< "${KEEP_BRANCHES}"
          for i in "${!KEEP_ARR[@]}"; do
            # trim whitespace
            KEEP_ARR[$i]="$(echo "${KEEP_ARR[$i]}" | xargs)"
          done

          is_kept_branch() {
            local b="$1"
            for k in "${KEEP_ARR[@]}"; do
              if [[ "$b" == "$k" ]]; then
                return 0
              fi
            done
            return 1
          }

          echo "Fetching branches..."
          # For each branch, we fetch its protection flag and head SHA
          gh api "repos/${REPO}/branches?per_page=100" --paginate \
            --jq '.[] | @base64' \
            | while read -r row; do
                _jq() { echo "$row" | base64 -d | jq -r "$1"; }

                BRANCH=$(_jq '.name')
                PROTECTED=$(_jq '.protected')
                SHA=$(_jq '.commit.sha')

                if is_kept_branch "$BRANCH"; then
                  echo "SKIP (keep-list): ${BRANCH}"
                  continue
                fi

                if [[ "${PROTECTED}" == "true" ]]; then
                  echo "SKIP (protected): ${BRANCH}"
                  continue
                fi

                # Get last commit date for the branch head
                COMMIT_DATE=$(gh api "repos/${REPO}/commits/${SHA}" --jq '.commit.committer.date')
                COMMIT_EPOCH=$(date -d "${COMMIT_DATE}" +%s)

                if (( COMMIT_EPOCH < CUTOFF_EPOCH )); then
                  if [[ "${DRY_RUN}" == "true" ]]; then
                    echo "DRY RUN: would delete ${BRANCH} (last commit ${COMMIT_DATE})"
                  else
                    echo "Deleting ${BRANCH} (last commit ${COMMIT_DATE})"
                    gh api -X DELETE "repos/${REPO}/git/refs/heads/${BRANCH}"
                  fi
                else
                  echo "KEEP (recent): ${BRANCH} (last commit ${COMMIT_DATE})"
                fi
              done
