name: On Issue Assignment to Specific User

on:
  issues:
    types: [assigned]

permissions:
  issues: write
  contents: read
  
jobs:
  notify-assignment:
    runs-on:
      group: ai-developer
    outputs:
      should_investigate: ${{ steps.check-status.outputs.should_investigate }}
      should_implement: ${{ steps.check-status.outputs.should_implement }}
      issue_url: ${{ steps.check-status.outputs.issue_url }}
      project_item_id: ${{ steps.get-project-state.outputs.project_item_id }}
      status_field_id: ${{ steps.get-project-state.outputs.status_field_id }}
      development_option_id: ${{ steps.get-project-state.outputs.development_option_id }}
      dev_review_option_id: ${{ steps.get-project-state.outputs.dev_review_option_id }}
    steps:
      - name: Check if assigned to target user
        id: check-assignee
        run: |
          ASSIGNEE="${{ github.event.assignee.login }}"
          # Add usernames to watch for (space-separated)
          TARGET_USERS="elitea-ai"
          
          if echo "$TARGET_USERS" | grep -qw "$ASSIGNEE"; then
            echo "match=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Issue #${{ github.event.issue.number }} assigned to watched user: $ASSIGNEE"
          else
            echo "match=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Issue assigned to $ASSIGNEE (not a watched user)"
          fi

      - name: Get project board state
        if: steps.check-assignee.outputs.match == 'true'
        id: get-project-state
        uses: actions/github-script@v7
        env:
          TARGET_PROJECT_NAME: "ELITEA Board"
        with:
          github-token: ${{ secrets.PROJECT_GIT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            // Query the issue directly to get its project memberships
            const query = `
              query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    number
                    title
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                          title
                          number
                          field(name: "Status") {
                            ... on ProjectV2SingleSelectField {
                              id
                              options {
                                id
                                name
                              }
                            }
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            console.log(`Querying issue #${context.issue.number}`);
            
            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issueNumber: context.issue.number
            });
            
            const issue = result.repository.issue;
            const projectItems = issue.projectItems.nodes;
            
            console.log(`Issue is in ${projectItems.length} project(s)`);
            
            if (projectItems.length === 0) {
              console.log('Issue not in any project');
              core.setOutput('has_project', 'false');
              return;
            }
            
            const targetProjectName = process.env.TARGET_PROJECT_NAME;
            let targetProjectItem;
            
            if (targetProjectName) {
              targetProjectItem = projectItems.find(item => item.project.title === targetProjectName);
              if (!targetProjectItem) {
                console.log(`Issue not in project "${targetProjectName}"`);
                core.setOutput('has_project', 'false');
                return;
              }
            } else {
              targetProjectItem = projectItems[0];
            }
            
            console.log(`Found in project: ${targetProjectItem.project.title}`);
            
            const statusField = targetProjectItem.fieldValues.nodes.find(
              node => node.field?.name === 'Status'
            );
            
            if (statusField) {
              console.log(`Status: ${statusField.name}`);
              core.setOutput('project_status', statusField.name);
              core.setOutput('project_name', targetProjectItem.project.title);
              core.setOutput('has_project', 'true');
              
              // Save IDs needed to update the status later
              core.setOutput('project_item_id', targetProjectItem.id);
              core.setOutput('status_field_id', targetProjectItem.project.field?.id);
              
              // Find Development option ID
              const developmentOption = targetProjectItem.project.field?.options?.find(
                opt => opt.name === 'Development'
              );
              if (developmentOption) {
                core.setOutput('development_option_id', developmentOption.id);
              }

              // Find Dev Review option ID
              const devReviewOption = targetProjectItem.project.field?.options?.find(
                opt => opt.name === 'Dev Review'
              );
              if (devReviewOption) {
                core.setOutput('dev_review_option_id', devReviewOption.id);
              }
            } else {
              console.log('Status field not found');
              core.setOutput('has_project', 'false');
            }

      - name: Take action based on project state
        if: steps.check-assignee.outputs.match == 'true' && steps.get-project-state.outputs.has_project == 'true'
        id: check-status
        run: |
          echo "=== Issue Details ==="
          echo "Title: ${{ github.event.issue.title }}"
          echo "URL: ${{ github.event.issue.html_url }}"
          echo "Assignee: ${{ github.event.assignee.login }}"
          echo "Project: ${{ steps.get-project-state.outputs.project_name }}"
          echo "Status/Column: ${{ steps.get-project-state.outputs.project_status }}"
          echo ""
          
          STATUS="${{ steps.get-project-state.outputs.project_status }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          
          # Set output for issue URL
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          
          if [[ "$STATUS" == "To Do" || "$STATUS" == "Bugs" ]]; then
            echo "üìã Issue is in TO DO or BUGS column - will trigger investigation"
            echo "should_investigate=true" >> $GITHUB_OUTPUT
            echo "should_implement=false" >> $GITHUB_OUTPUT

          elif [[ "$STATUS" == "Development" ]]; then
            echo "üíª Issue is in DEVELOPMENT column - will trigger auto-fixer directly"
            echo "should_investigate=false" >> $GITHUB_OUTPUT
            echo "should_implement=true" >> $GITHUB_OUTPUT

          elif [[ "$STATUS" == "In Testing" || "$STATUS" == "Dev Review" ]]; then
            echo "üß™ Issue is in testing/review column - no action needed"
            echo "should_investigate=false" >> $GITHUB_OUTPUT
            echo "should_implement=false" >> $GITHUB_OUTPUT

          else
            echo "‚ÑπÔ∏è Issue is in column: $STATUS - no action"
            echo "should_investigate=false" >> $GITHUB_OUTPUT
            echo "should_implement=false" >> $GITHUB_OUTPUT
          fi

  investigate-issue:
    needs: notify-assignment
    if: needs.notify-assignment.outputs.should_investigate == 'true'
    runs-on:
      group: ai-developer
    steps:
      - name: Debug - Check outputs
        run: |
          echo "Should investigate: ${{ needs.notify-assignment.outputs.should_investigate }}"
          echo "Issue URL: ${{ needs.notify-assignment.outputs.issue_url }}"
          echo "Runner: $(hostname)"
          echo "Working directory: $(pwd)"
      
      - name: Run autonomous RCA investigation
        id: rca-investigation
        working-directory: /Volumes/KINGSTON/Development/elitea
        timeout-minutes: 30
        env:
          CLAUDE_CONFIG_DIR: /Volumes/KINGSTON/Development/elitea/.claude
        run: |
          echo "üîç Starting autonomous investigation for issue: ${{ needs.notify-assignment.outputs.issue_url }}"
          echo "Working directory: $(pwd)"
          echo "CLAUDE_CONFIG_DIR: $CLAUDE_CONFIG_DIR"

          # Read model names from settings.json
          SETTINGS_FILE="$CLAUDE_CONFIG_DIR/settings.json"
          export ANTHROPIC_SMALL_FAST_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")
          export ANTHROPIC_DEFAULT_HAIKU_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")
          export CLAUDE_CODE_SUBAGENT_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")

          echo "Using model for subagents: $ANTHROPIC_SMALL_FAST_MODEL"
          echo "Checking .claude/agents directory:"
          ls -la .claude/agents
          # Run with explicit prompt flag
          ISSUE_URL="${{ needs.notify-assignment.outputs.issue_url }}"
          echo "Investigating issue: $ISSUE_URL"
          claude --debug --dangerously-skip-permissions --agent autonomous-rca-investigator -p "Investigate this GitHub issue and post your RCA findings as comments: $ISSUE_URL"

      - name: Move ticket to Development column
        if: steps.rca-investigation.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_GIT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const mutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: $value
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            // Get the project ID from the item ID (extract from project item)
            const getProjectQuery = `
              query($itemId: ID!) {
                node(id: $itemId) {
                  ... on ProjectV2Item {
                    project {
                      id
                    }
                  }
                }
              }
            `;

            const projectData = await github.graphql(getProjectQuery, {
              itemId: "${{ needs.notify-assignment.outputs.project_item_id }}"
            });

            const projectId = projectData.node.project.id;

            console.log('Moving issue to Development column...');

            await github.graphql(mutation, {
              projectId: projectId,
              itemId: "${{ needs.notify-assignment.outputs.project_item_id }}",
              fieldId: "${{ needs.notify-assignment.outputs.status_field_id }}",
              value: {
                singleSelectOptionId: "${{ needs.notify-assignment.outputs.development_option_id }}"
              }
            });

            console.log('‚úÖ Successfully moved to Development column');

      - name: Run auto-fixer implementation
        id: auto-fixer
        if: steps.rca-investigation.outcome == 'success'
        working-directory: /Volumes/KINGSTON/Development/elitea
        timeout-minutes: 60
        env:
          CLAUDE_CONFIG_DIR: /Volumes/KINGSTON/Development/elitea/.claude
        run: |
          echo "üîß Starting auto-fixer for issue: ${{ needs.notify-assignment.outputs.issue_url }}"
          echo "Working directory: $(pwd)"

          # Read model names from settings.json
          SETTINGS_FILE="$CLAUDE_CONFIG_DIR/settings.json"
          export ANTHROPIC_SMALL_FAST_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")
          export ANTHROPIC_DEFAULT_HAIKU_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")
          export CLAUDE_CODE_SUBAGENT_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")

          echo "Using model for subagents: $ANTHROPIC_SMALL_FAST_MODEL"

          ISSUE_URL="${{ needs.notify-assignment.outputs.issue_url }}"
          echo "Implementing fixes for issue: $ISSUE_URL"
          claude --debug --dangerously-skip-permissions --agent rca-autofixer -p "Implement fixes for this GitHub issue based on the RCA analysis and create a pull request: $ISSUE_URL . If applicable test using playwright mcp."

      - name: Move ticket to Dev Review column
        if: steps.auto-fixer.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_GIT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const mutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: $value
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            const getProjectQuery = `
              query($itemId: ID!) {
                node(id: $itemId) {
                  ... on ProjectV2Item {
                    project {
                      id
                    }
                  }
                }
              }
            `;

            const projectData = await github.graphql(getProjectQuery, {
              itemId: "${{ needs.notify-assignment.outputs.project_item_id }}"
            });

            const projectId = projectData.node.project.id;

            console.log('Moving issue to Dev Review column...');

            await github.graphql(mutation, {
              projectId: projectId,
              itemId: "${{ needs.notify-assignment.outputs.project_item_id }}",
              fieldId: "${{ needs.notify-assignment.outputs.status_field_id }}",
              value: {
                singleSelectOptionId: "${{ needs.notify-assignment.outputs.dev_review_option_id }}"
              }
            });

            console.log('‚úÖ Successfully moved to Dev Review column');

      - name: Remove elitea-ai from assignees
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_GIT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const issueUrl = '${{ needs.notify-assignment.outputs.issue_url }}';

            // Parse owner, repo, and issue number from URL
            const urlMatch = issueUrl.match(/github\.com\/([^\/]+)\/([^\/]+)\/issues\/(\d+)/);
            if (!urlMatch) {
              console.log('Could not parse issue URL, skipping assignee removal');
              return;
            }

            const [, owner, repo, issueNumber] = urlMatch;
            console.log(`Removing elitea-ai from issue ${owner}/${repo}#${issueNumber}`);

            try {
              await github.rest.issues.removeAssignees({
                owner,
                repo,
                issue_number: parseInt(issueNumber),
                assignees: ['elitea-ai']
              });
              console.log('‚úÖ Successfully removed elitea-ai from assignees');
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not remove assignee: ${error.message}`);
            }

  # Job for tickets already in Development - skip RCA, run auto-fixer directly
  implement-fixes:
    needs: notify-assignment
    if: needs.notify-assignment.outputs.should_implement == 'true'
    runs-on:
      group: ai-developer
    steps:
      - name: Debug - Check outputs
        run: |
          echo "Should implement: ${{ needs.notify-assignment.outputs.should_implement }}"
          echo "Issue URL: ${{ needs.notify-assignment.outputs.issue_url }}"
          echo "Runner: $(hostname)"
          echo "Working directory: $(pwd)"

      - name: Run auto-fixer implementation
        id: auto-fixer
        working-directory: /Volumes/KINGSTON/Development/elitea
        timeout-minutes: 60
        env:
          CLAUDE_CONFIG_DIR: /Volumes/KINGSTON/Development/elitea/.claude
        run: |
          echo "üîß Starting auto-fixer for issue: ${{ needs.notify-assignment.outputs.issue_url }}"
          echo "Working directory: $(pwd)"

          # Read model names from settings.json
          SETTINGS_FILE="$CLAUDE_CONFIG_DIR/settings.json"
          export ANTHROPIC_SMALL_FAST_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")
          export ANTHROPIC_DEFAULT_HAIKU_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")
          export CLAUDE_CODE_SUBAGENT_MODEL=$(jq -r '.env.ANTHROPIC_DEFAULT_SONNET_MODEL' "$SETTINGS_FILE")

          echo "Using model for subagents: $ANTHROPIC_SMALL_FAST_MODEL"

          ISSUE_URL="${{ needs.notify-assignment.outputs.issue_url }}"
          echo "Implementing fixes for issue: $ISSUE_URL"
          claude --debug --dangerously-skip-permissions --agent rca-autofixer -p "Implement fixes for this GitHub issue based on the RCA analysis and create a pull request: $ISSUE_URL . If applicable test using playwright mcp."

      - name: Move ticket to Dev Review column
        if: steps.auto-fixer.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_GIT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const mutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: $value
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;

            const getProjectQuery = `
              query($itemId: ID!) {
                node(id: $itemId) {
                  ... on ProjectV2Item {
                    project {
                      id
                    }
                  }
                }
              }
            `;

            const projectData = await github.graphql(getProjectQuery, {
              itemId: "${{ needs.notify-assignment.outputs.project_item_id }}"
            });

            const projectId = projectData.node.project.id;

            console.log('Moving issue to Dev Review column...');

            await github.graphql(mutation, {
              projectId: projectId,
              itemId: "${{ needs.notify-assignment.outputs.project_item_id }}",
              fieldId: "${{ needs.notify-assignment.outputs.status_field_id }}",
              value: {
                singleSelectOptionId: "${{ needs.notify-assignment.outputs.dev_review_option_id }}"
              }
            });

            console.log('‚úÖ Successfully moved to Dev Review column');

      - name: Remove elitea-ai from assignees
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_GIT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const issueUrl = '${{ needs.notify-assignment.outputs.issue_url }}';

            // Parse owner, repo, and issue number from URL
            const urlMatch = issueUrl.match(/github\.com\/([^\/]+)\/([^\/]+)\/issues\/(\d+)/);
            if (!urlMatch) {
              console.log('Could not parse issue URL, skipping assignee removal');
              return;
            }

            const [, owner, repo, issueNumber] = urlMatch;
            console.log(`Removing elitea-ai from issue ${owner}/${repo}#${issueNumber}`);

            try {
              await github.rest.issues.removeAssignees({
                owner,
                repo,
                issue_number: parseInt(issueNumber),
                assignees: ['elitea-ai']
              });
              console.log('‚úÖ Successfully removed elitea-ai from assignees');
            } catch (error) {
              console.log(`‚ö†Ô∏è Could not remove assignee: ${error.message}`);
            }
