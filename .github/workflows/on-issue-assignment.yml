name: On Issue Assignment to Specific User

on:
  issues:
    types: [assigned]

jobs:
  notify-assignment:
    runs-on: ubuntu-latest
    steps:
      - name: Check if assigned to target user
        id: check-assignee
        run: |
          ASSIGNEE="${{ github.event.assignee.login }}"
          # Add usernames to watch for (space-separated)
          TARGET_USERS="elitea-ai"
          
          if echo "$TARGET_USERS" | grep -qw "$ASSIGNEE"; then
            echo "match=true" >> $GITHUB_OUTPUT
            echo "âœ… Issue #${{ github.event.issue.number }} assigned to watched user: $ASSIGNEE"
          else
            echo "match=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Issue assigned to $ASSIGNEE (not a watched user)"
          fi

      - name: Get project board state
        if: steps.check-assignee.outputs.match == 'true'
        id: get-project-state
        uses: actions/github-script@v7
        env:
          # Set your target project board name (leave empty to check first project found)
          TARGET_PROJECT_NAME: "AI-Dev"  # e.g., "Development Sprint" or "Main Board"
        with:
          script: |
            const query = `
              query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    projectItems(first: 10) {
                      nodes {
                        project {
                          title
                          number
                        }
                        fieldValues(first: 10) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const variables = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issueNumber: context.issue.number
            };
            
            const result = await github.graphql(query, variables);
            const projectItems = result.repository.issue.projectItems.nodes;
            
            if (projectItems.length > 0) {
              const targetProjectName = process.env.TARGET_PROJECT_NAME;
              
              // Filter by project name if specified
              let projectItem;
              if (targetProjectName) {
                projectItem = projectItems.find(
                  item => item.project.title === targetProjectName
                );
                if (!projectItem) {
                  console.log(`Issue not in project: ${targetProjectName}`);
                  core.setOutput('has_project', 'false');
                  return;
                }
              } else {
                projectItem = projectItems[0];
              }
              
              const statusField = projectItem.fieldValues.nodes.find(
                node => node.field?.name === 'Status'
              );
              
              if (statusField) {
                console.log(`Project: ${projectItem.project.title} (#${projectItem.project.number})`);
                console.log(`Status: ${statusField.name}`);
                core.setOutput('project_status', statusField.name);
                core.setOutput('project_name', projectItem.project.title);
                core.setOutput('has_project', 'true');
              } else {
                core.setOutput('has_project', 'false');
              }
            } else {
              console.log('Issue not in any project');
              core.setOutput('has_project', 'false');
            }

      - name: Take action based on project state
        if: steps.check-assignee.outputs.match == 'true' && steps.get-project-state.outputs.has_project == 'true'
        run: |
          echo "Issue Details:"
          echo "Title: ${{ github.event.issue.title }}"
          echo "URL: ${{ github.event.issue.html_url }}"
          echo "Assignee: ${{ github.event.assignee.login }}"
          echo "Project Status: ${{ steps.get-project-state.outputs.project_status }}"
          
          # Check for specific statuses
          STATUS="${{ steps.get-project-state.outputs.project_status }}"
          if [[ "$STATUS" == "In Progress" || "$STATUS" == "Todo" ]]; then
            echo "âœ… Issue is in active status"
          fi

      # Example: Add a comment to the issue
      - name: Add comment to issue
        if: steps.check-assignee.outputs.match == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ‘‹ This issue has been assigned to a priority user and will be tracked accordingly.'
            })
