name: On Issue Assignment to Specific User

on:
  issues:
    types: [assigned]

jobs:
  notify-assignment:
    runs-on: ubuntu-latest
    steps:
      - name: Check if assigned to target user
        id: check-assignee
        run: |
          ASSIGNEE="${{ github.event.assignee.login }}"
          # Add usernames to watch for (space-separated)
          TARGET_USERS="elitea-ai"
          
          if echo "$TARGET_USERS" | grep -qw "$ASSIGNEE"; then
            echo "match=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Issue #${{ github.event.issue.number }} assigned to watched user: $ASSIGNEE"
          else
            echo "match=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Issue assigned to $ASSIGNEE (not a watched user)"
          fi

      - name: Get project board state
        if: steps.check-assignee.outputs.match == 'true'
        id: get-project-state
        uses: actions/github-script@v7
        env:
          TARGET_PROJECT_NAME: "ELITEA Board"
        with:
          script: |
            // Query the issue directly to get its project memberships
            const query = `
              query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    number
                    title
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          title
                          number
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            console.log(`Querying issue #${context.issue.number}`);
            
            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issueNumber: context.issue.number
            });
            
            const issue = result.repository.issue;
            const projectItems = issue.projectItems.nodes;
            
            console.log(`Issue is in ${projectItems.length} project(s)`);
            
            if (projectItems.length === 0) {
              console.log('Issue not in any project');
              core.setOutput('has_project', 'false');
              return;
            }
            
            const targetProjectName = process.env.TARGET_PROJECT_NAME;
            let targetProjectItem;
            
            if (targetProjectName) {
              targetProjectItem = projectItems.find(item => item.project.title === targetProjectName);
              if (!targetProjectItem) {
                console.log(`Issue not in project "${targetProjectName}"`);
                core.setOutput('has_project', 'false');
                return;
              }
            } else {
              targetProjectItem = projectItems[0];
            }
            
            console.log(`Found in project: ${targetProjectItem.project.title}`);
            
            const statusField = targetProjectItem.fieldValues.nodes.find(
              node => node.field?.name === 'Status'
            );
            
            if (statusField) {
              console.log(`Status: ${statusField.name}`);
              core.setOutput('project_status', statusField.name);
              core.setOutput('project_name', targetProjectItem.project.title);
              core.setOutput('has_project', 'true');
            } else {
              console.log('Status field not found');
              core.setOutput('has_project', 'false');
            }

      - name: Take action based on project state
        if: steps.check-assignee.outputs.match == 'true' && steps.get-project-state.outputs.has_project == 'true'
        run: |
          echo "=== Issue Details ==="
          echo "Title: ${{ github.event.issue.title }}"
          echo "URL: ${{ github.event.issue.html_url }}"
          echo "Assignee: ${{ github.event.assignee.login }}"
          echo "Project: ${{ steps.get-project-state.outputs.project_name }}"
          echo "Status/Column: ${{ steps.get-project-state.outputs.project_status }}"
          echo ""
          
          STATUS="${{ steps.get-project-state.outputs.project_status }}"
          
          if [[ "$STATUS" == "To Do" || "$STATUS" == "Bugs" ]]; then
            echo "üìã Issue is in TO DO or BUGS column - taking initial action"
            
          elif [[ "$STATUS" == "Development" ]]; then
            echo "üíª Issue is in DEVELOPMENT column - taking development action"
            
          elif [[ "$STATUS" == "In Testing" ]]; then
            echo "üß™ Issue is in IN TESTING column - taking QA action"
            
          else
            echo "‚ÑπÔ∏è Issue is in column: $STATUS"
          fi

      # Example: Add a comment to the issue
      - name: Add comment to issue
        if: steps.check-assignee.outputs.match == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üëã This issue has been assigned to a priority user and will be tracked accordingly.'
            })
