name: On Issue Assignment to Specific User

on:
  issues:
    types: [assigned]

jobs:
  notify-assignment:
    runs-on: ubuntu-latest
    steps:
      - name: Check if assigned to target user
        id: check-assignee
        run: |
          ASSIGNEE="${{ github.event.assignee.login }}"
          # Add usernames to watch for (space-separated)
          TARGET_USERS="elitea-ai"
          
          if echo "$TARGET_USERS" | grep -qw "$ASSIGNEE"; then
            echo "match=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Issue #${{ github.event.issue.number }} assigned to watched user: $ASSIGNEE"
          else
            echo "match=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Issue assigned to $ASSIGNEE (not a watched user)"
          fi

      - name: Get project board state
        if: steps.check-assignee.outputs.match == 'true'
        id: get-project-state
        uses: actions/github-script@v7
        env:
          # Set your target project name (NOT the view/board name)
          # The project is the container, views like "AI-Dev" are just filtered displays
          TARGET_PROJECT_NAME: "ELITEA Board"  # Your GitHub Project name
        with:
          script: |
            // Try organization-level projects first
            const orgQuery = `
              query($org: String!) {
                organization(login: $org) {
                  projectsV2(first: 20) {
                    nodes {
                      title
                      number
                      items(first: 100) {
                        nodes {
                          content {
                            ... on Issue {
                              number
                              repository {
                                name
                              }
                            }
                          }
                          fieldValues(first: 10) {
                            nodes {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                name
                                field {
                                  ... on ProjectV2FieldCommon {
                                    name
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const variables = {
              org: context.repo.owner
            };
            
            console.log(`Looking for issue #${context.issue.number} in org ${context.repo.owner}, repo ${context.repo.repo}`);
            
            const result = await github.graphql(orgQuery, variables);
            const projects = result.organization.projectsV2.nodes;
            
            console.log(`Found ${projects.length} projects in organization`);
            
            const targetProjectName = process.env.TARGET_PROJECT_NAME;
            let targetProject = null;
            
            if (targetProjectName) {
              targetProject = projects.find(p => p.title === targetProjectName);
              if (!targetProject) {
                console.log(`Project "${targetProjectName}" not found`);
                core.setOutput('has_project', 'false');
                return;
              }
              console.log(`Found project: ${targetProject.title}`);
            }
            
            // Find the issue in the project
            const projectToSearch = targetProject || projects[0];
            const projectItem = projectToSearch.items.nodes.find(item => {
              const content = item.content;
              return content && 
                     content.number === variables.issueNumber && 
                     content.repository?.name === variables.repo;
            });context.issue.number && 
                     content.repository?.name === context.repo.repo;
            });
            
            if (!projectItem) {
              console.log(`Issue #${context.issue.n
            }
            
            console.log(`‚úÖ Found issue in project "${projectToSearch.title}"`);
            
            const statusField = projectItem.fieldValues.nodes.find(
              node => node.field?.name === 'Status'
            );
            
            if (statusField) {
              console.log(`Project: ${projectToSearch.title} (#${projectToSearch.number})`);
              console.log(`Status: ${statusField.name}`);
              core.setOutput('project_status', statusField.name);
              core.setOutput('project_name', projectToSearch.title);
              core.setOutput('has_project', 'true');
            } else {
              console.log('Status field not found');
              console.log('Available fields:', projectItem.fieldValues.nodes.map(n => n.field?.name));
              core.setOutput('has_project', 'false');
            }

      - name: Take action based on project state
        if: steps.check-assignee.outputs.match == 'true' && steps.get-project-state.outputs.has_project == 'true'
        run: |
          echo "=== Issue Details ==="
          echo "Title: ${{ github.event.issue.title }}"
          echo "URL: ${{ github.event.issue.html_url }}"
          echo "Assignee: ${{ github.event.assignee.login }}"
          echo "Project: ${{ steps.get-project-state.outputs.project_name }}"
          echo "Status/Column: ${{ steps.get-project-state.outputs.project_status }}"
          echo ""
          
          STATUS="${{ steps.get-project-state.outputs.project_status }}"
          
          if [[ "$STATUS" == "To Do" || "$STATUS" == "Bugs" ]]; then
            echo "üìã Issue is in TO DO or BUGS column - taking initial action"
            
          elif [[ "$STATUS" == "Development" ]]; then
            echo "üíª Issue is in DEVELOPMENT column - taking development action"
            
          elif [[ "$STATUS" == "In Testing" ]]; then
            echo "üß™ Issue is in IN TESTING column - taking QA action"
            
          else
            echo "‚ÑπÔ∏è Issue is in column: $STATUS"
          fi

      # Example: Add a comment to the issue
      - name: Add comment to issue
        if: steps.check-assignee.outputs.match == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üëã This issue has been assigned to a priority user and will be tracked accordingly.'
            })
