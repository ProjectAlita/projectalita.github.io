name: On Issue Assignment to Specific User

on:
  issues:
    types: [assigned]

permissions:
  issues: write
  contents: read
  
jobs:
  notify-assignment:
    runs-on: ubuntu-latest
    outputs:
      should_investigate: ${{ steps.check-status.outputs.should_investigate }}
      issue_url: ${{ steps.check-status.outputs.issue_url }}
      project_item_id: ${{ steps.get-project-state.outputs.project_item_id }}
      status_field_id: ${{ steps.get-project-state.outputs.status_field_id }}
      development_option_id: ${{ steps.get-project-state.outputs.development_option_id }}
    steps:
      - name: Check if assigned to target user
        id: check-assignee
        run: |
          ASSIGNEE="${{ github.event.assignee.login }}"
          # Add usernames to watch for (space-separated)
          TARGET_USERS="elitea-ai"
          
          if echo "$TARGET_USERS" | grep -qw "$ASSIGNEE"; then
            echo "match=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Issue #${{ github.event.issue.number }} assigned to watched user: $ASSIGNEE"
          else
            echo "match=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Issue assigned to $ASSIGNEE (not a watched user)"
          fi

      - name: Get project board state
        if: steps.check-assignee.outputs.match == 'true'
        id: get-project-state
        uses: actions/github-script@v7
        env:
          TARGET_PROJECT_NAME: "ELITEA Board"
        with:
          github-token: ${{ secrets.PROJECT_GIT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            // Query the issue directly to get its project memberships
            const query = `
              query($owner: String!, $repo: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    number
                    title
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                          title
                          number
                          field(name: "Status") {
                            ... on ProjectV2SingleSelectField {
                              id
                              options {
                                id
                                name
                              }
                            }
                          }
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            console.log(`Querying issue #${context.issue.number}`);
            
            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issueNumber: context.issue.number
            });
            
            const issue = result.repository.issue;
            const projectItems = issue.projectItems.nodes;
            
            console.log(`Issue is in ${projectItems.length} project(s)`);
            
            if (projectItems.length === 0) {
              console.log('Issue not in any project');
              core.setOutput('has_project', 'false');
              return;
            }
            
            const targetProjectName = process.env.TARGET_PROJECT_NAME;
            let targetProjectItem;
            
            if (targetProjectName) {
              targetProjectItem = projectItems.find(item => item.project.title === targetProjectName);
              if (!targetProjectItem) {
                console.log(`Issue not in project "${targetProjectName}"`);
                core.setOutput('has_project', 'false');
                return;
              }
            } else {
              targetProjectItem = projectItems[0];
            }
            
            console.log(`Found in project: ${targetProjectItem.project.title}`);
            
            const statusField = targetProjectItem.fieldValues.nodes.find(
              node => node.field?.name === 'Status'
            );
            
            if (statusField) {
              console.log(`Status: ${statusField.name}`);
              core.setOutput('project_status', statusField.name);
              core.setOutput('project_name', targetProjectItem.project.title);
              core.setOutput('has_project', 'true');
              
              // Save IDs needed to update the status later
              core.setOutput('project_item_id', targetProjectItem.id);
              core.setOutput('status_field_id', targetProjectItem.project.field?.id);
              
              // Find Development option ID
              const developmentOption = targetProjectItem.project.field?.options?.find(
                opt => opt.name === 'Development'
              );
              if (developmentOption) {
                core.setOutput('development_option_id', developmentOption.id);
              }
            } else {
              console.log('Status field not found');
              core.setOutput('has_project', 'false');
            }

      - name: Take action based on project state
        if: steps.check-assignee.outputs.match == 'true' && steps.get-project-state.outputs.has_project == 'true'
        id: check-status
        run: |
          echo "=== Issue Details ==="
          echo "Title: ${{ github.event.issue.title }}"
          echo "URL: ${{ github.event.issue.html_url }}"
          echo "Assignee: ${{ github.event.assignee.login }}"
          echo "Project: ${{ steps.get-project-state.outputs.project_name }}"
          echo "Status/Column: ${{ steps.get-project-state.outputs.project_status }}"
          echo ""
          
          STATUS="${{ steps.get-project-state.outputs.project_status }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          
          # Set output for issue URL
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          
          if [[ "$STATUS" == "To Do" || "$STATUS" == "Bugs" ]]; then
            echo "üìã Issue is in TO DO or BUGS column - will trigger investigation"
            echo "should_investigate=true" >> $GITHUB_OUTPUT
            
          elif [[ "$STATUS" == "Development" ]]; then
            echo "üíª Issue is in DEVELOPMENT column - taking development action"
            echo "should_investigate=false" >> $GITHUB_OUTPUT
            
          elif [[ "$STATUS" == "In Testing" ]]; then
            echo "üß™ Issue is in IN TESTING column - taking QA action"
            echo "should_investigate=false" >> $GITHUB_OUTPUT
            
          else
            echo "‚ÑπÔ∏è Issue is in column: $STATUS"
            echo "should_investigate=false" >> $GITHUB_OUTPUT
          fi

  investigate-issue:
    needs: notify-assignment
    if: needs.notify-assignment.outputs.should_investigate == 'true'
    runs-on: [self-hosted, macOS]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run autonomous RCA investigation
        run: |
          echo "üîç Starting autonomous investigation for issue: ${{ needs.notify-assignment.outputs.issue_url }}"
          claude --dangerously-skip-permissions --agent autonomous-rca-investigator "${{ needs.notify-assignment.outputs.issue_url }}"
      
      - name: Move ticket to Development column
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_GIT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const mutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: $value
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            // Get the project ID from the item ID (extract from project item)
            const getProjectQuery = `
              query($itemId: ID!) {
                node(id: "${{ needs.notify-assignment.outputs.project_item_id }}") {
                  ... on ProjectV2Item {
                    project {
                      id
                    }
                  }
                }
              }
            `;
            
            const projectData = await github.graphql(getProjectQuery, {
              itemId: "${{ needs.notify-assignment.outputs.project_item_id }}"
            });
            
            const projectId = projectData.node.project.id;
            
            console.log('Moving issue to Development column...');
            
            await github.graphql(mutation, {
              projectId: projectId,
              itemId: "${{ needs.notify-assignment.outputs.project_item_id }}",
              fieldId: "${{ needs.notify-assignment.outputs.status_field_id }}",
              value: {
                singleSelectOptionId: "${{ needs.notify-assignment.outputs.development_option_id }}"
              }
            });
            
            console.log('‚úÖ Successfully moved to Development column');
