name: Set Reporter field for issues

on:
  workflow_dispatch:
    inputs:
      max_issues:
        description: "Maximum number of issues to process (1-100)"
        required: false
        default: "100"

jobs:
  set-reporter-bulk:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      issues: write

    env:
      ORG_LOGIN: ProjectAlita
      PROJECT_NUMBER: "3"
      PROJECT_TITLE: "ELITEA Board"
      REPORTER_FIELD_NAME: "Reporter"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect open issues (limit by input)
        id: list_issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const maxIssues = Math.max(1, Math.min(100, parseInt(core.getInput('max_issues') || '100', 10)));
            const { owner, repo } = context.repo;

            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: 'open', per_page: Math.min(maxIssues, 100) }
            );

            const list = issues.slice(0, maxIssues).map(i => ({
              number: i.number,
              node_id: i.node_id,
              reporter: i.user.login
            }));
            core.info(`Collected ${list.length} open issues (max ${maxIssues}).`);
            return JSON.stringify(list)

      - name: Ensure items in project and set Reporter field
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const { ORG_LOGIN, PROJECT_NUMBER, PROJECT_TITLE, REPORTER_FIELD_NAME } = process.env;

            // Parse previous step output safely
            const raw = `${{ steps.list_issues.outputs.result }}`;
            const issues = raw ? JSON.parse(raw) : [];
            if (!issues.length) {
              core.info('No issues to process.');
              return;
            }

            // Resolve the ProjectV2: try by number, then by exact title
            const projectByNumberQuery = `
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) { id title }
                }
              }
            `;
            const projectsByTitleQuery = `
              query($org: String!, $query: String!, $first: Int!) {
                organization(login: $org) {
                  projectsV2(first: $first, query: $query) {
                    nodes { id title }
                  }
                }
              }
            `;

            let projectId = null;
            try {
              const resp = await github.graphql(projectByNumberQuery, {
                org: ORG_LOGIN,
                number: parseInt(PROJECT_NUMBER, 10),
              });
              projectId = resp?.organization?.projectV2?.id || null;
              if (projectId) {
                core.info(`Resolved project by number: ${resp.organization.projectV2.title} (ID: ${projectId})`);
              } else {
                core.info(`ProjectV2 #${PROJECT_NUMBER} not found by number; trying title lookup...`);
              }
            } catch (e) {
              core.info(`Lookup by number failed: ${e.message}. Trying title lookup...`);
            }

            if (!projectId) {
              const resp2 = await github.graphql(projectsByTitleQuery, {
                org: ORG_LOGIN,
                query: PROJECT_TITLE,
                first: 20,
              });
              const candidates = resp2?.organization?.projectsV2?.nodes || [];
              const match = candidates.find(p => p.title === PROJECT_TITLE);
              if (!match) {
                core.setFailed(`Could not resolve Projects v2 titled "${PROJECT_TITLE}" in org ${ORG_LOGIN}.`);
                return;
              }
              projectId = match.id;
              core.info(`Resolved project by title: ${PROJECT_TITLE} (ID: ${projectId})`);
            }

            // Fetch fields to find the "Reporter" field and get its node ID
            const fieldsQuery = `
              query($projectId: ID!, $first: Int!, $after: String) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    fields(first: $first, after: $after) {
                      nodes {
                        __typename
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2IterationField {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                        }
                      }
                      pageInfo {
                        endCursor
                        hasNextPage
                      }
                    }
                  }
                }
              }
            `;

            let reporterFieldId = null;
            let after = null;
            while (true) {
              const res = await github.graphql(fieldsQuery, { projectId, first: 50, after });
              const fields = res?.node?.fields?.nodes || [];
              for (const f of fields) {
                if (f?.name === REPORTER_FIELD_NAME) {
                  reporterFieldId = f.id;
                  break;
                }
              }
              if (reporterFieldId || !res.node.fields.pageInfo.hasNextPage) break;
              after = res.node.fields.pageInfo.endCursor;
            }
            if (!reporterFieldId) {
              core.setFailed(`Field "${REPORTER_FIELD_NAME}" not found on project.`);
              return;
            }
            core.info(`Reporter field ID: ${reporterFieldId}`);

            // GraphQL defs
            const addItemMutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                  item { id }
                }
              }
            `;
            const updateFieldMutationText = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { text: $value }
                }) {
                  projectV2Item { id }
                }
              }
            `;
            const listItemsQuery = `
              query($projectId: ID!, $after: String) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    items(first: 50, after: $after) {
                      nodes {
                        id
                        content {
                          __typename
                          ... on Issue { id number }
                        }
                      }
                      pageInfo { endCursor hasNextPage }
                    }
                  }
                }
              }
            `;

            // Helper: find or create project item for issue node
            async function ensureItemForIssue(issueNodeId, issueNumber) {
              let after = null;
              while (true) {
                const res = await github.graphql(listItemsQuery, { projectId, after });
                const items = res.node.items;

                const found = items.nodes.find(n => n.content?.__typename === 'Issue' && n.content?.id === issueNodeId);
                if (found) {
                  core.info(`Issue #${issueNumber}: existing item ${found.id}`);
                  return found.id;
                }

                if (!items.pageInfo.hasNextPage) break;
                after = items.pageInfo.endCursor;
              }

              // Not found, add it
              const addResp = await github.graphql(addItemMutation, { projectId, contentId: issueNodeId });
              const itemId = addResp.addProjectV2ItemById.item.id;
              core.info(`Issue #${issueNumber}: added item ${itemId}`);
              return itemId;
            }

            // Process each issue
            for (const { number, node_id, reporter } of issues) {
              try {
                const itemId = await ensureItemForIssue(node_id, number);
                await github.graphql(updateFieldMutationText, {
                  projectId,
                  itemId,
                  fieldId: reporterFieldId,
                  value: reporter,
                });
                core.info(`Issue #${number}: Reporter="${reporter}" set on item ${itemId}`);
              } catch (err) {
                core.warning(`Issue #${number}: ${err.message}`);
              }
            }
